<!-- admin/index.html -->
<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>

    <!-- Include the styles for the Netlify CMS UI, after your own styles -->
    <link rel="stylesheet" href="canvas.css" />
    <link rel="stylesheet" href="https://unpkg.com/netlify-cms@^1.0.0/dist/cms.css" />

</head>
<body>
    <!-- Include the script that builds the page and powers Netlify CMS -->
    <script src="https://unpkg.com/netlify-cms@^1.0.0/dist/cms.js"></script>
    <script>
//initialisation variable

var completeDrawing = document.createElement("completeDrawingLayer");
var isPainting = false;
var layerNo = 0;

var canvasList = [];

var shapeCanvasList = [];
var textCanvasList = [];
    
var userStrokeStyle = '#FFC0CB';
var line = [];
var prevPos = { offsetX: 0, offsetY: 0 };
var longueur=0;
var rect = {};
var paint = false;
var clickX = new Array();
var clickY = new Array();
var clickDrag = new Array();
var drawingMode = 'shape';


function hello()
{
alert('hello');
}

function addClick(x, y, dragging)
        {
            clickX.push(x);
            clickY.push(y);
            clickDrag.push(dragging);
        }

function redraw(){
	var canvas = document.getElementById('singleStrokeLayer');
	var ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height); // Clears the canvas
             
        ctx.strokeStyle = "#333";
        ctx.lineJoin = "round";
        ctx.lineWidth = 8;
             
        for(var i=0; i < clickX.length; i++) 
	{       
        	ctx.beginPath();
                if(clickDrag[i] && i)
		{
                    ctx.moveTo(clickX[i-1], clickY[i-1]);
                }
		else
		{
                    ctx.moveTo(clickX[i]-1, clickY[i]);
                }
                ctx.lineTo(clickX[i], clickY[i]);
                ctx.closePath();
                ctx.stroke();
            }
        }

function exportt()
{
//export complete drawing
        var completeDrawing = document.getElementById("completeDrawingLayer")
        var image = completeDrawing.toDataURL("image/png").replace("image/png", "image/octet-stream");

        //new element a which is a link (href) to the image : permits download
        var link = document.createElement('a');
        link.download = "image.png";
        link.href = image;
        link.click();
}

function erase() 
    {
        //clear the complete drawing canvas
        var canvas = document.getElementById('completeDrawingLayer');
	var ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);

	for(var i = 1; i <= canvasList.length; i++)
        {
            var node = document.getElementById('thumbnail'+i);
            document.getElementById('historique').removeChild(node);
        }
	
        clickX = [];
	clickY = [];
	clickDrag = [];

        //clear the single stroke canvas
        
        
        this.layerNo = 0;
        this.canvasList = [];
        this.shapeCanvasList = [];
        this.textCanvasList = [];
    }

function mouseDown(e) 
{
	
	//alert('je suis en mouseDown');
	var canvas = document.getElementById('singleStrokeLayer');
	var ctx = canvas.getContext('2d');	
	var mouseX = e.pageX - canvas.offsetLeft;
        var mouseY = e.pageY - canvas.offsetTop;
        
	paint = true;
        addClick(e.pageX - canvas.offsetLeft, e.pageY - canvas.offsetTop);
        redraw();
}

function newSingleStroke()
{
	this.layerNo = this.layerNo + 1;

        var singleStroke = document.getElementById("singleStrokeLayer");
        var singleCtx = singleStroke.getContext('2d');

        //draw on complete drawing canvas
	var canvas = document.getElementById("completeDrawingLayer");
	var destCtx = canvas.getContext('2d');
	destCtx.drawImage(singleStroke, 0, 0);
	
        var image = singleStroke.toDataURL("image/png").replace("image/png", "image/octet-stream");

        var img = document.createElement('img');
	img.setAttribute('id', 'thumbnail');
        img.src = image;
        img.style.width="300px";
        img.style.height="150px";

        var div = document.getElementById('historique');

	var infoDiv = document.createElement('div');
        infoDiv.setAttribute('id', 'infodiv');
        
        var drawingMod = document.createElement('img');
        drawingMod.setAttribute('class', 'iconMode')
        if (drawingMode == 'shape')
        {
            drawingMod.src = 'shapes.png';
        }
        if (drawingMode == 'text')
        {
            drawingMod.src = 'text.png';
        }

        infoDiv.appendChild(drawingMod);

	var divThumbnail = document.createElement('div');
        divThumbnail.setAttribute('id', 'thumbnail'+layerNo);
        divThumbnail.setAttribute('class', 'divThumbnail');
        divThumbnail.appendChild(img);
        divThumbnail.appendChild(infoDiv);

        div.appendChild(divThumbnail);

	var tempcanvas = document.createElement('canvas');
        tempcanvas.setAttribute('id', "canvas"+layerNo);
        tempcanvas.setAttribute('width', canvas.width);
        tempcanvas.setAttribute('height', canvas.height);
        tempcanvas.setAttribute("layerType", drawingMode);
        tempcanvas.setAttribute("modelType", "class");
        
        if (drawingMode == 'shape')
        {
            shapeCanvasList.push(tempcanvas);
        }
        else if (drawingMode == 'text')
        {
            textCanvasList.push(tempcanvas);
        }
        
        canvasList.push(tempcanvas);
}

function setModeText()
    {
        drawingMode = "text";
        var textbutton = document.getElementById('text-button');
        textbutton.style.backgroundColor = "#E5DFFF";
        
        var shapebutton = document.getElementById('shape-button');
        shapebutton.style.backgroundColor = "transparent ";
    }

function setModeShape()
    {
        drawingMode = "shape";
        var shapebutton = document.getElementById('shape-button');
        shapebutton.style.backgroundColor = "#E5DFFF";
        
        var textbutton = document.getElementById('text-button');
        textbutton.style.backgroundColor = "transparent";
    }

function mouseUp() 
{
	//alert('je suis en MouseUp');
	if (paint)
	{
		paint = false;
		newSingleStroke();
		
		//clear the single stroke canvas
		var singleStroke = document.getElementById("singleStrokeLayer");
        	var singleCtx = singleStroke.getContext('2d');
        	singleCtx.clearRect(0, 0, singleStroke.width, singleStroke.height);
		clickX = [];
		clickY = [];
		clickDrag = [];
	}
}



function mouseMove(e) 
{
	//alert('je suis en mouseMove');
	var canvas = document.getElementById('singleStrokeLayer');
	var   ctx = canvas.getContext('2d');
	//alert(paint);
	if(paint)
	{
                addClick(e.pageX - canvas.offsetLeft, e.pageY - canvas.offsetTop, true);
                redraw();
        }
}

function init() {
	var canvas = document.getElementById('singleStrokeLayer');
	var ctx = canvas.getContext('2d');
	canvas.addEventListener('mousedown', mouseDown, false);
	canvas.addEventListener('mouseup', mouseUp, false);
	canvas.addEventListener('mousemove', mouseMove, false); 
}

function postPictureEngineV2()
    {
        var xhr = new XMLHttpRequest();
        var url = "localhost:8888/postPictureEngineV2";
        xhr.onreadystatechange = function() 
        {
            if(xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) // 200 quand on sera en NETWORK
            {		
                var engineDiv = document.getElementById("engineDiv");
                var paraph = document.createElement("p");
                var response = xhr.responseText.split("%split%");
                paraph.innerHTML=response[0];
                var shouldILoop=0;
                var diagramDiv = document.getElementById("myDiagramDiv");

                if(go.Diagram.fromDiv(diagramDiv)!=null)
                {
                    go.Diagram.fromDiv(diagramDiv).div = null;
                }

                ReactJson.initClass(response[1]);		// the loadFromJSON is made in initClass
                    //loadFromJSONClass(response[1]);
            }
                //engineDiv.appendChild(paraph);
                engineDiv.insertBefore(paraph,engineDiv.firstChild);
		}
	

        xhr.open("POST", url, true);
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        
        /*var canvasList = this.layerTab;
        var shapeCanvasList = new Array();
        var textCanvasList = new Array();
        for(var i=0;i<canvasList.length;i++)
        {
            if(canvasList[i].getAttribute("layerType")=="shape")
            {
                shapeCanvasList.push(canvasList[i]);
            }
            if(canvasList[i].getAttribute("layerType")=="text")
            {
                textCanvasList.push(canvasList[i]);
            }
        }
        
        var request = "engineModel=class";
        request += "&shapeLayersSize="+shapeCanvasList.length;
        request += "&textLayersSize="+textCanvasList.length;
        var sizeShapeCanvasList = shapeCanvasList.length;
        for(var i=0;i<sizeShapeCanvasList;i++)
        {
            var uri = saveCanvas(shapeCanvasList[i]);
            var bbox = getBoundingBox(shapeCanvasList[i]);
            request+="&uri"+i+"="+uri+"&x"+i+"="+bbox[0]+"&y"+i+"="+bbox[1]+"&w"+i+"="+bbox[2]+"&h"+i+"="+bbox[3];
        }
        
        for(var i=0;i<textCanvasList.length;i++)
        {
            var uri = saveCanvas(textCanvasList[i]);
            var bbox = getBoundingBox(textCanvasList[i]);
            request+="&uri"+(i+sizeShapeCanvasList)+"="+uri+"&x"+(i+sizeShapeCanvasList)+"="+bbox[0]+"&y"+(i+sizeShapeCanvasList)+"="+bbox[1]+"&w"+(i+sizeShapeCanvasList)+"="+bbox[2]+"&h"+(i+sizeShapeCanvasList)+"="+bbox[3];
        }*/
    
        //xhr.send(request);
    }

var CanvasControl = createClass({

  render: function() {
    return h('div', {},
      h('img', {src : 'class.png'}),

      h('div', {id:'buttonsdiv'},
      	h('div',{id:'actions', class:'actions'},
      		h('div',{class:'inner'},
      			h('button',{onClick : ()=> exportt()}, 'Export')),
      		h('div',{class:'inner'},
      			h('button',{onClick : ()=> erase()}, 'Clear all'))),

      	h('div',{id:'modes', class:'modes'},
      		h('div',{class:'inner'},
      			h('button',{id:'text-button', onClick : ()=> setModeText()}, 'Text')),
      		h('div',{class:'inner'},
      			h('button',{id:'shape-button', onClick : ()=> setModeShape()}, 'Shape'))),

      h('br'),
      h('div', {id :'mainDiv', style:{'position':'relative'}},
      h('canvas',{id: 'singleStrokeLayer', style :{'background': '#E4F4FB', 'left':'0px', 'top':'0px','border':'1px solid #000000'}, height:'500',width:'500', onClick : ()=>init()},'canv'),
      h('canvas',{id: 'completeDrawingLayer', style :{'background': 'transparent', 'left':'0px', 'top':'0px', 'border':'1px solid #000000'},  height:'500',width:'500'},'canv'),
      h('div', {id: 'analyseDiv'},
	h('div',{id:'myDiagramDiv'}),
	h('div',{id:'engineDiv'})),
      h('div',{id : 'historique', class : 'container'}))));

//dans la division on met 2 buttons, un canvas ...
  }
});
CMS.registerWidget('canvasWidget', CanvasControl);
//to Block ne pas mettr  le stream HTML, on met ce q'on veut persister
//ecrire le contenu du fichier JSON
//to Preview done le JSON  a canvas goJS uqi se debrouille pour faire le rendering 
//dans quelle methode est le code du browsing? 

CMS.registerEditorComponent({
  // Internal id of the component
  id: "canvas",
  // Visible label
  label: "Canvas",
  // Fields the user need to fill out when adding an instance of the component
  fields: [{name: 'id', label: 'Canvas ID', widget: 'canvasWidget'}],
  // Pattern to identify a block as being an instance of this component
  pattern: /^{{< youtube (\S+) >}}$/,
  // Function to extract data elements from the regexp match
  fromBlock: function(match) {
    return {
      id: match[1]
    };
  },
  // Function to create a text block from an instance of this component
  toBlock: function(obj) {
    return `{{< Canvas ${obj.id} >}}`;
  },
  // Preview output for this component. Can either be a string or a React component
  // (component gives better render performance)
  toPreview: function(obj) {
    return (
      `<img src="https://img.youtube.com/vi/${obj.id}/maxresdefault.jpg" alt="Youtube Video"/>`
    );
  }
});

    </script>
</body>
</html>
